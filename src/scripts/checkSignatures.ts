import { Psbt } from "bitcoinjs-lib";

// Funci√≥n para convertir un string hexadecimal en Uint8Array
function hexToUint8Array(hex: string): Uint8Array {
    if (hex.length % 2 !== 0) {
        throw new Error("Hex string must have an even number of characters");
    }
    const length = hex.length / 2;
    const uint8Array = new Uint8Array(length);
    for (let i = 0; i < length; i++) {
        uint8Array[i] = parseInt(hex.substr(i * 2, 2), 16);
    }
    return uint8Array;
}

// Tu PSBT en formato hexadecimal
//const psbtHex = "70736274ff0100520200000001a2e5e6653ffdc5c640337f8dd6a37299c4fecd2694c5795a0bf21d0fcecebe2c0000000000ffffffff01983a000000000000160014a7891d762f6672ff20e188fb4d41981df3d9d07800000000000100fd73010200000000010282be83e48baf5ab0ddb64925cb21585e15d6c5313dc4392a1b2b3f605b0e83d70000000000ffffffffa4380bfdb2ee037f506798288a907a2af6b16ef40f295d848bbff3459621981c0400000000ffffffff022202000000000000160014a7891d762f6672ff20e188fb4d41981df3d9d078522e000000000000160014a7891d762f6672ff20e188fb4d41981df3d9d078024730440220368c6b12aa158591d1aceb3d725e88a09121edfb6f123b35fd5d0ec0cef5d59c02205313a7086206ed18e534ded00b6e2f0257dbe00c62a1abe83b6515704ef5ff75012102b5bf70e8ed4e33a56d449fd99a9b1f704a4d91682b6aaf984af8501c7118ebd502483045022100a129adece455be0dbdb70d2f61faf50a8fac1431d3526a00dc7a02374c5ee76002201b2558780adf01c17d6bcab13378a78c296a84839599afc47753cf5b85976baf012102b5bf70e8ed4e33a56d449fd99a9b1f704a4d91682b6aaf984af8501c7118ebd500000000220202b5bf70e8ed4e33a56d449fd99a9b1f704a4d91682b6aaf984af8501c7118ebd5473044022012a12097fad06a95700e6d2781cc764bae6b53ce251ac8d786dda690d10c737902203db1b322e460ed9a0dbaa637097c2a22dbb7ee5e612699ba334e392327f714c283010304830000000000";
const psbtHex ="70736274ff0100fd01010200000003954aa04bbf84c7e2adee3b8b4c5491412d38c7935724464cee97db30d3b754220100000000ffffffffa2e5e6653ffdc5c640337f8dd6a37299c4fecd2694c5795a0bf21d0fcecebe2c0000000000ffffffff36d9efdd52fc05099c54a07f2f11089f237bfe75ed3ff1f78ab67a1d4c4426a20100000000ffffffff0422020000000000001600148a59f83a118c946fe31d6275fe40c090541aa2c7983a000000000000160014a7891d762f6672ff20e188fb4d41981df3d9d0781027000000000000160014b49b6200b09c5229d4effae4498364ef02b620642b450000000000001600148a59f83a118c946fe31d6275fe40c090541aa2c700000000000100f902000000000101782945b6b00daa117e8ba9e6c5e9ae846a1c659d1d22a3ee6da23bc1fbc8ffb90100000000ffffffff020000000000000000306a2e5326b006a3b028355465a4e79a9bc84530773f60e38533b71ad25f747765a57ca20dfa83be739f9e8a4474522486f4560000000000001600148a59f83a118c946fe31d6275fe40c090541aa2c702483045022100d7ff849b85bf65803405c595d1f85f5c8efc09fe4991efa324dedf7234e5be050220402aaf230fd17bed58e718600feb1203a62a1c633026692737708491a9bd8cb0012102b5671257a8e02c79e80985efe413be1b0b090da806203842b01f6edd3524dc6a000000000103048100000000000100e702000000000101c73abdee6eeb094f5d3af0fc83888a386dea82dbe5438a30a5241d8f306ffdc80100000000fdffffff0200000000000000001f6a1d3443b3dc460db92bf6bd920f00469f7aa26fb61691883f6daed6a570fa41550000000000001600148a59f83a118c946fe31d6275fe40c090541aa2c70247304402206c3eee762e96ea57248e2df9987caa6306b6d3ed1527f83fe42537a00f2c07e3022006aa2c9a71b6f0776a1637f1d700dd277e59046d50e83cf371574f1cd70bd702012102b5671257a8e02c79e80985efe413be1b0b090da806203842b01f6edd3524dc6a00000000010304810000000000000000";

// Convertir la PSBT de hex a Uint8Array
const psbtBytes = hexToUint8Array(psbtHex);

// Parsear la PSBT
const psbt = Psbt.fromBuffer(psbtBytes);

// Verificar firmas parciales en los inputs
const hasPartialSignatures = psbt.data.inputs.some((input, index) => {
    console.log(index)
    console.log(input.partialSig)
    return input.partialSig !== undefined
});

console.log({ inputs: psbt.data.inputs.length })
const hasFinalizedInputs = psbt.data.inputs.some(input => input.finalScriptWitness !== undefined || input.finalScriptSig !== undefined);

// Determinar el estado de la PSBT
const result = {
    parcialmente_firmada: hasPartialSignatures && !hasFinalizedInputs,
    completamente_firmada: hasFinalizedInputs,
    sin_firmas: !hasPartialSignatures && !hasFinalizedInputs
};

// Mostrar el resultado
console.log("Estado de la PSBT:", result);
